<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Threat_Quest: Cyber Incident Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* General Terminal Styling */
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        body { font-family: 'VT323', monospace; background-color: #000; color: #00ff00; font-size: 1.25rem; line-height: 1.5; }
        .container-box { max-width: none; }
        .terminal-header { color: #00ff00; text-shadow: 0 0 5px #00ff00; }
        .text-glow { text-shadow: 0 0 3px #00ff00; }
        .terminal-button { background-color: transparent; border: none; color: #00ff00; border-radius: 0; transition: all 0.1s ease-in-out; padding: 0.5rem 1rem; }
        .terminal-button:hover { background-color: #00ff00; color: #000; transform: none; box-shadow: none; }
        .card-box { background-color: #000; border: none; border-radius: 0; }
        .final-score { color: #00ff00; text-shadow: 0 0 5px #00ff00; }
        #story-content.menu-mode { min-height: 400px; display: flex; flex-direction: column; justify-content: center; align-items: center; }

        /* --- THIS IS THE NEW RULE FOR ASCII ART --- */
        pre {
            font-family: 'VT323', monospace; /* Use the game font */
            color: #00ff00;                 /* Match the game text color */
            text-shadow: 0 0 3px #00ff00;   /* Match the game glow */
            line-height: 1.1;               /* Make art a bit tighter */
            font-size: 1rem;                /* Adjust size if needed */
        }
    </style>
</head>
<body class="flex justify-center min-h-screen p-8">
    <div id="game-container" class="w-full container-box">
        <h1 class="font-['VT323'] text-4xl mb-4 terminal-header text-center">Threat_Quest: Loading Scenarios...</h1>
        
        <div id="story-content" class="hidden" style="display: none;"> 
            <div id="story-text" class="text-lg leading-relaxed mb-8 min-h-[100px] text-glow flex justify-center">
                <div id="centered-passage" class="w-full max-w-2xl text-left">
                </div>
            </div>
            <div id="choices-container" class="flex flex-col space-y-4 items-center"></div>
        </div>

        <div id="game-over-container" class="hidden" style="display: none;">
            <div id="results-card" class="card-box p-6 mb-6">
                <h2 class="text-2xl font-bold mb-2 text-glow text-center">Simulation Complete</h2>
                <p class="text-xl font-mono text-center">Final Score: <span id="final-score" class="final-score font-bold"></span></p>
            </div>
            <div id="feedback-card" class="card-box p-6 mb-6"></div>
            
            <div id="game-end-menu" class="flex flex-col space-y-4 items-center pt-4"></div>
        </div>

    </div>

    <script>
        
        // --- GLOBAL GAME STATE VARIABLES ---
        let currentSceneKey; 
        let score;
        let mistakes;
        let scenarioLibrary = {}; // Stores ALL scenarios keyed by ID
        let scenarioData = null; // Stores the CURRENT active scenario object
        
        // NEW GLOBAL CONSTANT FOR SCORING FALLBACK
        const PASSING_SCORE_THRESHOLD = 75; 

        // --- DOM Elements ---
        const titleEl = document.querySelector('h1');
        const storyContentEl = document.getElementById('story-content');
        const storyTextEl = document.getElementById('story-text');
        const centeredPassageEl = document.getElementById('centered-passage'); // The inner element for text content
        const choicesContainerEl = document.getElementById('choices-container');
        const gameOverContainerEl = document.getElementById('game-over-container');
        const finalScoreEl = document.getElementById('final-score');
        const feedbackCardEl = document.getElementById('feedback-card');
        const gameEndMenuEl = document.getElementById('game-end-menu');

        const HISTORY_KEY = 'threatQuestHistory';

        // Helper to retrieve the current passage from the ACTIVE scenario
        const getPassage = (key) => scenarioData.passages[key];


        // --- SCENARIO LOADING: FETCHES AND PARSES ALL DATA ---
        async function loadScenario() {
            try {
                // --- THIS IS THE MODIFIED LINE ---
                // It adds a unique timestamp to the file request to "bust" the cache.
                const response = await fetch('scenarios_config.json?v=' + new Date().getTime());
                // --- END OF MODIFIED LINE ---
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const configArray = await response.json();

                // Convert the array into a scenario library object, keyed by scenarioId
                scenarioLibrary = {};
                configArray.forEach(scenario => {
                    // Convert the passages array into a lookup map (Passage ID -> Passage Object)
                    const passagesMap = {};
                    scenario.passages.forEach(passage => {
                        passagesMap[passage.id] = passage;
                    });
                    
                    scenario.passages = passagesMap;
                    scenarioLibrary[scenario.scenarioId] = scenario;
                });

                showScenarioSelector(); // Display the list of available scenarios

            } catch (e) {
                console.error("Failed to load scenario configuration:", e);
                titleEl.textContent = "Error: File Missing";
                centeredPassageEl.innerHTML = `<p class="text-red-500 text-center">ERROR: Could not load scenarios_config.json. Ensure the file exists and is correctly formatted.</p>`;
                storyContentEl.style.display = 'flex';
                storyContentEl.classList.add('menu-mode');
                choicesContainerEl.style.display = 'none';
            }
        }
        
        // --- SCENARIO SELECTOR MENU ---
        function showScenarioSelector() {
            resetContainers();

            storyContentEl.classList.add('menu-mode');
            storyContentEl.classList.remove('hidden');
            storyContentEl.style.display = 'flex';

            titleEl.textContent = "Threat_Quest: Select Scenario";
            centeredPassageEl.innerHTML = "Welcome! Select the cybersecurity incident you want to simulate.";
            centeredPassageEl.classList.add('text-center'); 
            centeredPassageEl.classList.remove('text-left'); 

            choicesContainerEl.innerHTML = '';
            choicesContainerEl.classList.remove('hidden');
            choicesContainerEl.classList.add('space-y-4');

            // 1. Create buttons for each scenario in the library
            Object.values(scenarioLibrary).forEach((scenario, index) => {
                const button = document.createElement('button');
                button.textContent = `${index + 1}. ${scenario.scenarioTitle}`;
                button.className = "terminal-button font-bold py-3 px-6 w-full";
                
                button.addEventListener('click', () => {
                    startSelectedScenario(scenario.scenarioId);
                });
                choicesContainerEl.appendChild(button);
            });
            
            // 2. Add history button
            const historyLength = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]').length;
            const historyBtn = document.createElement('button');
            historyBtn.textContent = `View Past Attempts (${historyLength})`;
            historyBtn.className = historyLength > 0 
                ? "terminal-button font-bold py-3 px-6 w-full mt-4"
                : "terminal-button font-bold py-3 px-6 w-full mt-4 opacity-50 cursor-not-allowed pointer-events-none";
            
            if (historyLength > 0) {
                historyBtn.addEventListener('click', showHistoryMenu);
            }
            choicesContainerEl.appendChild(historyBtn);
        }

        // --- CORE GAME FLOW FUNCTIONS ---

        const startSelectedScenario = (scenarioId) => {
            // Set the global variable to the chosen scenario object
            scenarioData = scenarioLibrary[scenarioId]; 
            
            // Initialize game state
            score = 100;
            mistakes = [];
            currentSceneKey = scenarioData.startPassageId;
            
            // Clear any old 'continue' save
